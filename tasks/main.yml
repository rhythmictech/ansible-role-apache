---
# compat for amazon linux
- set_fact: ansible_distribution_major_version=6
  when: ansible_distribution == "Amazon" and ansible_distribution_major_version == "NA"
  tags: ['apache']

- set_fact: ansible_distribution_major_version=7
  when: ansible_distribution == "Amazon" and ansible_distribution_major_version == "2"
  tags: ['apache']

# tasks for apache
- name: ensure apache packages are installed
  yum: name="{{ packages }}" state=present lock_timeout=180
  vars:
    packages:
      - httpd
      - collectd-apache
  tags: ['apache']

- name: ensure the base httpd config is in place
  template:
    src: "etc.httpd.conf.httpd.conf.j2"
    dest: "/etc/httpd/conf/httpd.conf"
    owner: root
    group: apache
    mode: 0640
  notify: reload httpd
  tags: ['apache']

- name: ensure the mpm config is in place
  template:
    src: "etc.httpd.conf.modules.d.00-mpm.conf.j2"
    dest: "/etc/httpd/conf.modules.d/00-mpm.conf"
    owner: root
    group: root
    mode: 0644
  notify: restart httpd
  when: ansible_distribution_major_version == '7'
  tags: ['apache']

- name: ensure mod_autoindex is disabled
  file:
    path: "/etc/httpd/conf.d/autoindex.conf"
    state: absent
  notify: restart httpd
  tags: ['apache']

- name: ensure the collectd httpd config is in place
  template:
    src: "etc.collectd.d.apache.conf.j2"
    dest: "/etc/collectd.d/apache.conf"
    owner: root
    group: apache
    mode: 0640
  when: apache_collectd_enable
  tags: ['collectd', 'apache']

- name: ensure the collectd httpd config is removed
  file:
    path: "/etc/collectd.d/apache.conf"
    state: absent
  when: not apache_collectd_enable
  tags: ['collectd', 'apache']

- name: ensure httpd is running and enabled
  service: name=httpd state=started enabled=true
  tags: ['apache']
